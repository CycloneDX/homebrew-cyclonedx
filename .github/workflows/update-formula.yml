name: Update a formula

on:
  workflow_dispatch:
    inputs: 
      subject:
        description: which formula to update?
        required: true
        type: choice
        options:
          - cli
          - gomod
      version:
        description: which version shall be published
        required: true
        type: string

permissions:
  contents: write # push commits 
  pull-requests: write # create pullrequests

jobs:
  update:
    name: "update formula: ${{ github.event.inputs.subject }} ${{ github.event.inputs.version }}"
    runs-on: macos-latest
    timeout-minutes: 10
    env:
      UF_SUBJECT: ${{ github.event.inputs.subject }}
      UF_VERSION: ${{ github.event.inputs.version }}
    steps:
      - name: Checkout
        # see https://github.com/actions/checkout
        uses: actions/checkout@v4
      - name: Update Formula
        run: >
          .github/scripts/update-formula/"${UF_SUBJECT}"/gen.sh 
          "${UF_VERSION}"
          > Formula/cyclonedx-"${UF_SUBJECT}".rb
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Test Formula
        # https://docs.brew.sh/Adding-Software-to-Homebrew#testing-and-auditing-the-formula 
        run: |
          export HOMEBREW_NO_AUTO_UPDATE=1
          FORMULA_FILE=./Formula/cyclonedx-"${UF_SUBJECT}".rb
          brew audit --fix --stric --online "$FORMULA_FILE"
          brew install --build-from-source "$FORMULA_FILE"
          brew deps "$FORMULA_FILE"
          brew test --verbose "$FORMULA_FILE"
          brew uninstall "$FORMULA_FILE"
      - name: Commit & Push
        run: |
          BRANCH_NAME="update-formula/${UF_SUBJECT}-${UF_VERSION}"
          git checkout -B "$BRANCH_NAME"
          git add -A Formula
          git config user.name "[BOT] Formula Updater"
          git config user.email "formula-updater@bot.local"
          git commit -s -m "Update ${UF_SUBJECT}: ${UF_VERSION}"
          git push -f --set-upstream origin "$BRANCH_NAME"
      - name: Open PullRequest
        run: gh pr create --fill-verbose --label "$UF_SUBJECT"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
